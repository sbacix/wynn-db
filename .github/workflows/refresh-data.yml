const fs = require('fs/promises');
const path = require('path');

const WYNN_API_URL = 'https://api.wynncraft.com/v3/item/database?fullResult';

async function run() {
    console.log("üöÄ Imperial Bot Engaged...");

    try {
        // 1. Fetch official stats (Tier, Level, IDs)
        const itemRes = await fetch(WYNN_API_URL);
        const itemsMap = await itemRes.json();

        // 2. Load your "32,000 lines" file
        let communityData = {};
        try {
            const commFile = await fs.readFile(path.join(__dirname, '../data/community_coords.json'), 'utf8');
            communityData = JSON.parse(commFile);
            console.log("üì¶ Community coordinates loaded!");
        } catch (e) {
            console.warn("‚ö†Ô∏è community_coords.json not found. Skipping enrichment.");
        }

        const ingredients = [];

        for (const [internalName, item] of Object.entries(itemsMap)) {
            const isIngredient = (item.requirements?.skills?.length > 0) || item.consumableOnlyIDs || item.ingredientPositionModifiers;
            if (!isIngredient) continue;

            // MERGE LOGIC: Use your high-quality data if available
            const communitySources = communityData[item.name] || communityData[internalName] || null;

            ingredients.push({
                internalName: internalName,
                name: item.name || internalName,
                tier: item.tier || "Normal",
                requirements: item.requirements || {},
                identifications: item.identifications || {},
                // This is where we store the community info
                communitySources: communitySources, 
                dropMeta: item.dropMeta || null
            });
        }

        const outDir = path.join(__dirname, '..', 'public', 'data');
        await fs.mkdir(outDir, { recursive: true });
        await fs.writeFile(path.join(outDir, 'ingredients.json'), JSON.stringify(ingredients));
        
        console.log(`‚úÖ Success. ${ingredients.length} assets gated.`);
    } catch (error) {
        console.error("‚ùå Critical failure:", error);
        process.exit(1);
    }
}
run();
